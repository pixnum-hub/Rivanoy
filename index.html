<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rivanoy</title>

<meta name="theme-color" content="#667eea">
<link rel="manifest" href="manifest.json">

<style>
*{box-sizing:border-box;font-family:system-ui,sans-serif}
body{
  margin:0;min-height:100vh;display:flex;justify-content:center;
  padding:12px;background:linear-gradient(135deg,#667eea,#764ba2)
}
.app{
  width:100%;max-width:380px;min-height:100vh;padding:16px;
  border-radius:22px;background:rgba(255,255,255,.18);
  backdrop-filter:blur(16px);color:#000;position:relative
}
input,button{
  width:100%;padding:12px;border-radius:12px;border:none;margin-bottom:10px
}
button{font-weight:bold;background:rgba(255,255,255,.35)}
.icon{font-size:48px;text-align:center}
.details{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.detail-card{
  background:rgba(255,255,255,.25);
  border-radius:16px;padding:12px;text-align:center
}
.big{font-size:26px;font-weight:bold}
.hourly,.forecast{
  display:flex;gap:12px;overflow-x:auto;margin-top:10px;padding-bottom:6px
}
.hour,.day{display:flex;flex-direction:column;align-items:center}
.hour-bar,.day-bar-max,.day-bar-min{
  width:22px;border-radius:6px 6px 0 0
}
.day-bar-container{
  display:flex;flex-direction:column-reverse;height:80px
}
.loading-overlay{
  position:absolute;inset:0;display:none;
  align-items:center;justify-content:center;
  background:rgba(255,255,255,.35);
  backdrop-filter:blur(8px);
  font-size:18px;border-radius:22px;z-index:10
}
@media(prefers-color-scheme:dark){
  body{background:linear-gradient(135deg,#0f2027,#203a43,#2c5364)}
  .app{background:rgba(0,0,0,.35);color:#fff}
}
</style>
</head>

<body>
<div class="app">
  <h1>ğŸŒ¦ Rivanoy</h1>

  <input id="cityInput" placeholder="Search city">
  <button id="searchBtn">Search</button>
  <button id="locBtn">ğŸ“ Use My Location</button>
  <button id="installBtn" style="display:none">â¬‡ Install App</button>

  <div class="loading-overlay" id="loading">Loadingâ€¦</div>

  <h2 id="location">Loading weatherâ€¦</h2>
  <div id="icon" class="icon">â›…</div>

  <p id="temp">--Â°</p>
  <p id="feels">Feels like --</p>
  <p id="wind">Wind --</p>
  <p id="humidity">Humidity --</p>
  <p id="updated">Updated --</p>

  <div class="details">
    <div class="detail-card">
      <h4>ğŸ§­ Wind Dir</h4>
      <div id="windDir" class="big">--</div>
    </div>
    <div class="detail-card">
      <h4>ğŸŒ« AQI (PM2.5)</h4>
      <div id="aqiValue" class="big">--</div>
      <div id="aqiLabel">--</div>
    </div>
  </div>

  <h3>ğŸ•’ Next 24 Hours</h3>
  <div class="hourly" id="hourly"></div>

  <h3>ğŸ“… 7-Day Forecast</h3>
  <div class="forecast" id="forecast"></div>

  <footer style="margin-top:20px;font-size:11px;text-align:center">
    Â© Manik Roy 2025. All Rights Reserved.
  </footer>
</div>

<script>
const $=id=>document.getElementById(id);
const loading=$("loading");

const icons={0:"â˜€",1:"ğŸŒ¤",2:"â›…",3:"â˜",45:"ğŸŒ«",61:"ğŸŒ§",71:"â„",95:"â›ˆ"};

function showLoading(v){loading.style.display=v?"flex":"none";}
function compass(d){return["N","NE","E","SE","S","SW","W","NW"][Math.round(d/45)%8];}

/* ---------- PWA INSTALL ---------- */
let deferredPrompt=null;
window.addEventListener("beforeinstallprompt",e=>{
  e.preventDefault();
  deferredPrompt=e;
  $("installBtn").style.display="block";
});
$("installBtn").onclick=async()=>{
  if(!deferredPrompt)return;
  deferredPrompt.prompt();
  await deferredPrompt.userChoice;
  deferredPrompt=null;
  $("installBtn").style.display="none";
};

/* ---------- WEATHER ---------- */
async function loadWeather(lat,lon,name){
  try{
    showLoading(true);

    const w=await fetch(
      `https://api.open-meteo.com/v1/forecast?latitude=${lat}&longitude=${lon}&current_weather=true&hourly=temperature_2m,apparent_temperature,relativehumidity_2m&daily=temperature_2m_min,temperature_2m_max,weathercode&timezone=auto`
    ).then(r=>r.json());

    const a=await fetch(
      `https://air-quality-api.open-meteo.com/v1/air-quality?latitude=${lat}&longitude=${lon}&hourly=pm2_5&timezone=auto`
    ).then(r=>r.json());

    $("location").textContent=name;
    $("temp").textContent=w.current_weather.temperature+"Â°C";
    $("feels").textContent="Feels like "+w.hourly.apparent_temperature[0]+"Â°C";
    $("wind").textContent="Wind "+w.current_weather.windspeed+" km/h";
    $("humidity").textContent="Humidity "+w.hourly.relativehumidity_2m[0]+"%";
    $("windDir").textContent=compass(w.current_weather.winddirection);
    $("icon").textContent=icons[w.current_weather.weathercode]||"â›…";
    $("updated").textContent="Updated "+new Date().toLocaleTimeString();

    const pm=a.hourly.pm2_5[0];
    $("aqiValue").textContent=pm;
    $("aqiLabel").textContent=pm<=30?"Good":pm<=60?"Moderate":pm<=90?"Poor":"Severe";

    buildHourly(w.hourly.temperature_2m.slice(0,24));
    buildForecast(w.daily);

    localStorage.setItem("rivanoy_last",JSON.stringify({lat,lon,name}));
  }catch{
    alert("Offline or network issue");
  }finally{
    showLoading(false);
  }
}

/* ---------- HOURLY ---------- */
function buildHourly(t){
  $("hourly").innerHTML="";
  const min=Math.min(...t),max=Math.max(...t),r=max-min||1;
  t.forEach(v=>{
    $("hourly").innerHTML+=`
      <div class="hour">
        <div class="hour-bar"
             style="height:${30+((v-min)/r)*80}px;background:#4fc3f7"></div>
        <small>${v}Â°</small>
      </div>`;
  });
}

/* ---------- 7-DAY FORECAST (MAX / MIN) ---------- */
function buildForecast(d){
  $("forecast").innerHTML="";
  d.time.forEach((x,i)=>{
    $("forecast").innerHTML+=`
      <div class="day">
        <div class="day-bar-container">
          <div class="day-bar-max"
               style="height:60px;background:#ff7043"
               title="Max ${d.temperature_2m_max[i]}Â°C"></div>
          <div class="day-bar-min"
               style="height:40px;background:#42a5f5"
               title="Min ${d.temperature_2m_min[i]}Â°C"></div>
        </div>

        <div>${icons[d.weathercode[i]]||"â›…"}</div>

        <small>
          <strong>${d.temperature_2m_max[i]}Â°</strong> /
          ${d.temperature_2m_min[i]}Â°
        </small>

        <small>${x.slice(5)}</small>
      </div>`;
  });
}

/* ---------- SEARCH ---------- */
$("searchBtn").onclick=async()=>{
  const q=$("cityInput").value.trim();
  if(!q)return;
  showLoading(true);
  const r=await fetch(
    `https://geocoding-api.open-meteo.com/v1/search?name=${q}&count=1`
  ).then(r=>r.json());
  if(r.results?.[0]){
    loadWeather(
      r.results[0].latitude,
      r.results[0].longitude,
      r.results[0].name+", "+r.results[0].country
    );
  }
  showLoading(false);
};

/* ---------- LOCATION ---------- */
$("locBtn").onclick=()=>{
  if(!navigator.geolocation)return alert("Location not supported");
  showLoading(true);
  navigator.geolocation.getCurrentPosition(
    p=>loadWeather(p.coords.latitude,p.coords.longitude,"Current Location"),
    ()=>{showLoading(false);alert("Enable location permission");}
  );
};

/* ---------- BOOT ---------- */
(function(){
  const c=JSON.parse(localStorage.getItem("rivanoy_last")||"null");
  c?loadWeather(c.lat,c.lon,c.name)
   :loadWeather(28.61,77.23,"Delhi, India");
})();

/* ---------- SERVICE WORKER ---------- */
if("serviceWorker" in navigator){
  navigator.serviceWorker.register("sw.js");
}
</script>
</body>
</html>

